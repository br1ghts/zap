  <div class="dashboard-grid">
    <div class="dashboard-sidebar">
      <section class="panel-card">
        <div class="hero-panel">
          <div class="hero-panel__content">
            <span class="badge badge--beta">Channel overview</span>
            <h1 class="">
              <span class="capitlized text-xl"><%= channel.displayName %></span>
            </h1>

            <div class="hero-metrics">
              <div>
                <span class="text-base">Last clip</span>
                <p class="text-sm"><%= lastClipLabel ?? 'No clips yet' %></p>
              </div>
            </div>
          </div>
          <div class="hero-panel__preview">
            <p class="muted-copy">Live status</p>
            <span class="status-badge <%= liveStatusClass %>"><%= liveStatusLabel %></span>
            <p class="muted-copy">Bot status</p>

            <div class="hero-badge-row">
              <span class="badge badge--status-ready">Online</span>
              <span class="badge badge--beta">Beta</span>
            </div>
            <div class="hero-kpi-grid hero-panel__kpis">
              <article class="stat-card">
                <span>Last clip</span>
                <strong class="text-xl"><%= lastClipLabel ?? 'No clips yet' %></strong>
              </article>
              <article class="stat-card">
                <span>Ready</span>
                <strong class="text-xl"><%= clipStats.ready %></strong>
                <span>Video ready for editing</span>
              </article>
              <article class="stat-card">
                <span>Failed</span>
                <strong class="text-xl"><%= clipStats.failed %></strong>
                <span>Needs attention</span>
              </article>
              <article class="stat-card">
                <span>Pending</span>
                <strong class="text-xl"><%= clipStats.pending %></strong>
                <span>Awaiting clip service</span>
              </article>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="dashboard-main">
      <section class="section">
        <% if (clipGroups.length === 0) { %>
          <div class="timeline-empty">
            No clips recorded yet. Keep redeeming <code>!clip</code> and hit refresh to see requests populate this view.
          </div>
        <% } else { %>
          <div class="clip-timeline" data-broadcaster-id="<%= channel.broadcasterId %>">
            <% clipGroups.forEach((group) => { %>
              <article class="clip-group">
                <header class="clip-group__header">
                  <div>
                    <p class="clip-group__label"><%= group.label %></p>
                    <p class="clip-group__subtitle"><%= group.subtitle %></p>
                  </div>
                  <span class="clip-group__count"><%= group.clips.length %> clip<%= group.clips.length === 1 ? '' : 's' %></span>
                </header>
                <div class="clip-group__list">
                  <% group.clips.forEach((clip) => {
                    const tone = clip.status === 'ok' ? 'ready' : clip.status === 'failed' ? 'failed' : 'pending';
                    const label = clip.status === 'ok' ? 'Ready' : clip.status === 'failed' ? 'Failed' : 'Pending';
                    const noteValue = clip.note ? clip.note.trim() : '';
                    const title = noteValue.length ? noteValue : 'Clip request';
                    const hasUrl = Boolean(clip.url);
                    const errorSummary = clip.error ? clip.error.split('\n')[0] : null;
                  %>
                    <article class="clip-card" data-status="<%= tone %>"<% if (hasUrl) { %> data-clip-url="<%= clip.url %>"<% } %>>
                      <% if (hasUrl) { %>
                        <a class="clip-card__thumb-link" href="<%= clip.url %>" target="_blank" rel="noreferrer">
                          <div
                            class="clip-thumb clip-thumb--loading"
                            data-clip-thumb
                            data-clip-url="<%= clip.url %>"
                            data-clip-id="<%= clip.clipId ?? '' %>"
                          >
                            <img class="clip-thumb__img" alt="<%= title %> thumbnail" data-clip-thumb-img />
                            <div class="clip-thumb__fallback" data-clip-thumb-fallback aria-hidden="true">
                              <svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
                                <path d="M5 5h11l4 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2zm0 2v10h12V9l-3-3H5z" />
                                <path d="M17 12l4 3-4 3z" />
                              </svg>
                              <span>Clip</span>
                            </div>
                            <div class="clip-thumb__skeleton" data-clip-thumb-skeleton></div>
                          </div>
                        </a>
                      <% } else { %>
                        <div class="clip-thumb clip-thumb--loading clip-thumb--disabled" data-clip-thumb>
                          <div class="clip-thumb__fallback" data-clip-thumb-fallback aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
                              <path d="M5 5h11l4 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2zm0 2v10h12V9l-3-3H5z" />
                              <path d="M17 12l4 3-4 3z" />
                            </svg>
                            <span>Clip</span>
                          </div>
                          <div class="clip-thumb__skeleton" data-clip-thumb-skeleton></div>
                        </div>
                      <% } %>
                      <div class="clip-card__meta">
                        <div class="clip-card__meta-row">
                          <p class="clip-card__time"><%= clip.createdAtLabel %></p>
                          <p class="clip-card__requester">by <%= clip.requestedBy %></p>
                        </div>
                        <p class="clip-card__title"><%= title %></p>
                        <% if (clip.error) { %>
                          <div class="clip-card__error">
                            <p class="clip-card__error-summary"><%= errorSummary %></p>
                            <details>
                              <summary>Error details</summary>
                              <pre><%= clip.error %></pre>
                            </details>
                          </div>
                        <% } %>
                      </div>
                      <div class="clip-card__actions">
                        <span class="clip-status clip-status--<%= tone %>"><%= label %></span>
                        <div class="clip-card__action-group">
                          <% if (hasUrl) { %>
                            <a class="clip-action clip-action--primary" href="<%= clip.url %>" target="_blank" rel="noreferrer">View clip</a>
                            <button type="button" class="clip-action clip-action--ghost" data-copy-url="<%= clip.url %>">Copy link</button>
                            <button
                              type="button"
                              class="clip-action clip-action--ghost"
                              data-clip-download
                              data-clip-id="<%= clip.clipId ?? '' %>"
                              data-clip-url="<%= clip.url %>"
                            >Download</button>
                          <% } else { %>
                            <span class="clip-action clip-action--placeholder">Awaiting clip service</span>
                          <% } %>
                        </div>
                      </div>
                    </article>
                  <% }) %>
                </div>
              </article>
            <% }) %>
          </div>
        <% } %>
      </section>
    </div>
  </div>
  <script>
    (function () {
      const timelineEl = document.querySelector('.clip-timeline');
      if (!timelineEl) {
        return;
      }

      const thumbnailCache = new Map();
      const PLACEHOLDER_SRC = '/assets/clip-placeholder.svg';

	      const parseClipIdFromUrl = (clipUrl) => {
	        if (!clipUrl) return '';
	        try {
	          const url = new URL(clipUrl);
	          if (url.hostname === 'clips.twitch.tv') {
	            return url.pathname.replace(/^\/+/, '').split('/')[0] ?? '';
	          }
	          const parts = url.pathname.split('/').filter(Boolean);
	          const clipIndex = parts.findIndex((segment) => segment === 'clip');
	          if (clipIndex >= 0 && parts[clipIndex + 1]) {
	            return parts[clipIndex + 1];
          }
          return parts[parts.length - 1] ?? '';
        } catch {
          return '';
        }
      };

      const fetchThumbnail = (clipId, clipUrl) => {
        if (!clipId && !clipUrl) {
          return Promise.resolve(null);
        }
        const cacheKey = clipId || clipUrl;
        if (thumbnailCache.has(cacheKey)) {
          return thumbnailCache.get(cacheKey);
        }
        const url = new URL('/api/clips/thumbnail', window.location.origin);
        if (clipId) url.searchParams.set('clipId', clipId);
        if (clipUrl) url.searchParams.set('clipUrl', clipUrl);
        const promise = fetch(url.toString(), { headers: { Accept: 'application/json' } })
          .then((res) => (res.ok ? res.json() : null))
          .then((payload) => (payload && payload.thumbnailUrl ? payload.thumbnailUrl : null))
          .catch(() => null);
        thumbnailCache.set(cacheKey, promise);
        return promise;
      };

      const applyFallbackState = (thumbEl) => {
        const img = thumbEl.querySelector('[data-clip-thumb-img]');
        if (img && img.src !== PLACEHOLDER_SRC) {
          img.onerror = null;
          img.onload = null;
          img.src = PLACEHOLDER_SRC;
          img.dataset.placeholderApplied = 'true';
        }
        thumbEl.classList.add('clip-thumb--fallback');
        thumbEl.classList.remove('clip-thumb--loading', 'clip-thumb--loaded');
      };

      const applyImageState = (thumbEl, src) => {
        const img = thumbEl.querySelector('[data-clip-thumb-img]');
        if (!img || !src) {
          applyFallbackState(thumbEl);
          return;
        }
        const handleLoaded = () => {
          thumbEl.classList.add('clip-thumb--loaded');
          thumbEl.classList.remove('clip-thumb--loading', 'clip-thumb--fallback');
          thumbEl.dataset.thumbnailUrl = src;
        };
        const handleError = () => {
          if (img.dataset.placeholderApplied === 'true') {
            return;
          }
          applyFallbackState(thumbEl);
        };
        img.onload = handleLoaded;
        img.onerror = handleError;
        if (img.src !== src) {
          img.dataset.placeholderApplied = 'false';
          img.src = src;
        } else if (img.complete) {
          handleLoaded();
        }
      };

      const hydrateThumbnail = async (thumbEl) => {
        const clipUrl = thumbEl.dataset.clipUrl;
        const known = thumbEl.dataset.thumbnailUrl;
        const datasetClipId = thumbEl.dataset.clipId;
        const clipId = datasetClipId && datasetClipId.trim().length ? datasetClipId.trim() : parseClipIdFromUrl(clipUrl);
        if (!clipUrl && !known) {
          applyFallbackState(thumbEl);
          return;
        }
        if (known) {
          applyImageState(thumbEl, known);
          return;
        }
        thumbEl.classList.add('clip-thumb--loading');
        const thumbnail = await fetchThumbnail(clipId, clipUrl);
        if (thumbnail) {
          applyImageState(thumbEl, thumbnail);
        } else {
          applyFallbackState(thumbEl);
        }
      };

      timelineEl.querySelectorAll('[data-clip-thumb]').forEach((thumbEl) => {
        hydrateThumbnail(thumbEl);
      });

      const fallbackCopy = (text) => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      };

      timelineEl.querySelectorAll('[data-copy-url]').forEach((button) => {
        const originalLabel = button.textContent;
        let feedbackTimer;
        button.addEventListener('click', async () => {
          const url = button.dataset.copyUrl;
          if (!url) {
            return;
          }
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(url);
            } else {
              fallbackCopy(url);
            }
            button.classList.add('clip-action--copied');
            button.textContent = 'Copied';
          } catch (error) {
            button.classList.add('clip-action--error');
            button.textContent = 'Copy failed';
          } finally {
            clearTimeout(feedbackTimer);
            feedbackTimer = setTimeout(() => {
              button.classList.remove('clip-action--copied', 'clip-action--error');
              button.textContent = originalLabel;
            }, 1400);
          }
        });
      });

      timelineEl.querySelectorAll('[data-clip-download]').forEach((button) => {
        const originalLabel = button.textContent;
        let busy = false;

        const setState = (next) => {
          busy = next.busy;
          button.disabled = next.busy;
          button.textContent = next.label ?? originalLabel;
          button.classList.toggle('clip-action--error', Boolean(next.error));
          button.setAttribute('aria-busy', next.busy ? 'true' : 'false');
        };

        button.addEventListener('click', async () => {
          if (busy) {
            return;
          }
          const broadcasterId = timelineEl.dataset.broadcasterId;
          const clipId = button.dataset.clipId;
          const clipUrl = button.dataset.clipUrl;
          if (!clipUrl || !broadcasterId) {
            return;
          }

          const resolvedClipId = clipId || parseClipIdFromUrl(clipUrl);
          if (!resolvedClipId) {
            return;
          }

          setState({ busy: true, label: 'Downloadingâ€¦', error: false });
          try {
            const urlEndpoint = new URL(
              `/api/twitch/clips/${encodeURIComponent(resolvedClipId)}/download-url`,
              window.location.origin
            );
            urlEndpoint.searchParams.set('broadcaster_id', broadcasterId);

            const res = await fetch(urlEndpoint.toString(), { credentials: 'same-origin' });
            if (!res.ok) {
              let detail = '';
              try {
                const json = await res.json();
                detail = json && json.error ? String(json.error) : '';
              } catch {
                try {
                  detail = await res.text();
                } catch {
                  detail = '';
                }
              }
              console.error('[clip download] failed', { status: res.status, detail });
              throw new Error(detail || `Download failed (${res.status})`);
            }

            const json = await res.json().catch(() => null);
            const downloadUrl = json && typeof json.downloadUrl === 'string' ? json.downloadUrl : '';
            if (!downloadUrl) {
              throw new Error('No download URL available');
            }

            const downloadEndpoint = new URL(
              `/api/twitch/clips/${encodeURIComponent(resolvedClipId)}/download`,
              window.location.origin
            );
            downloadEndpoint.searchParams.set('broadcaster_id', broadcasterId);

            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = downloadEndpoint.toString();
            document.body.appendChild(iframe);
            setTimeout(() => {
              try {
                document.body.removeChild(iframe);
              } catch {}
            }, 30000);
          } catch (error) {
            const message = error instanceof Error ? error.message : '';
            const label =
              message && message.toLowerCase().includes('reconnect twitch')
                ? 'Reconnect Twitch'
                : 'Download failed';
            setState({ busy: false, label, error: true });
            setTimeout(() => setState({ busy: false, label: originalLabel, error: false }), 1600);
            return;
          }
          setTimeout(() => setState({ busy: false, label: originalLabel, error: false }), 350);
        });
      });
    })();
  </script>

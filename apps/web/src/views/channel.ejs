<% const LIVE_THRESHOLD_MS = 1000 * 60 * 8; %>
<%
  const latestClip = clipGroups.length ? clipGroups[0].clips[0] : null;
  const lastClipMs = latestClip ? latestClip.createdAtMs : null;
  const isLive = lastClipMs !== null && Date.now() - lastClipMs < LIVE_THRESHOLD_MS;
  const liveStatusLabel = isLive ? 'Live now' : 'Offline';
  const liveStatusClass = isLive ? 'status-badge--ready' : 'status-badge--offline';
%>

<% const body = () => { %>
  <div class="dashboard-grid">
    <div class="dashboard-sidebar">
      <section class="panel-card">
        <div class="hero-panel">
          <div class="hero-panel__content">
            <span class="badge badge--beta">Channel overview</span>
            <h1 class="">
              <span class="capitlized text-xl"><%= channel.displayName %></span>
            </h1>

            <div class="hero-metrics">
              <div>
                <span class="text-base">Last clip</span>
                <p class="text-sm"><%= lastClipLabel ?? 'No clips yet' %></p>
              </div>
            </div>
          </div>
          <div class="hero-panel__preview">
            <p class="muted-copy">Live status</p>
            <span class="status-badge <%= liveStatusClass %>"><%= liveStatusLabel %></span>
            <p class="muted-copy">Bot status</p>

            <div class="hero-badge-row">
              <span class="badge badge--status-ready">Online</span>
              <span class="badge badge--beta">Beta</span>
            </div>
            <div class="hero-kpi-grid hero-panel__kpis">
              <article class="stat-card">
                <span>Last clip</span>
                <strong class="text-xl"><%= lastClipLabel ?? 'No clips yet' %></strong>
              </article>
              <article class="stat-card">
                <span>Ready</span>
                <strong  class="text-xl"><%= clipStats.ready %></strong>
                <span>Video ready for editing</span>
              </article>
              <article class="stat-card">
                <span>Failed</span>
                <strong class="text-xl"><%= clipStats.failed %></strong>
                <span>Needs attention</span>
              </article>
              <article class="stat-card">
                <span>Pending</span>
                <strong class="text-xl"><%= clipStats.pending %></strong>
                <span>Awaiting clip service</span>
              </article>




            </div>
          </div>
        </div>
      </section>

    </div>
    <div class="dashboard-main">
      <section class="section">

        <% if (clipGroups.length === 0) { %>
          <div class="timeline-empty">
            No clips recorded yet. Keep redeeming <code>!clip</code> and hit refresh to see requests populate this view.
          </div>
        <% } else { %>
          <div class="timeline">
            <% clipGroups.forEach((group) => { %>
              <article class="session-card">
                <div class="session-card__header">
                  <div>
                    <h3><%= group.label %></h3>
                    <p class="session-card__subtitle"><%= group.subtitle %></p>
                  </div>
                  <span class="session-card__count"><%= group.clips.length %> clip<%= group.clips.length === 1 ? '' : 's' %></span>
                </div>
                <hr class="timeline-divider" />
                <% group.clips.forEach((clip) => {
                  const tone = clip.status === 'ok' ? 'ready' : clip.status === 'failed' ? 'failed' : 'pending';
                  const label = clip.status === 'ok' ? 'Ready' : clip.status === 'failed' ? 'Failed' : 'Pending';
                %>
                  <div class="timeline-row" data-status="<%= tone %>">
                    <div class="timeline-row__timestamp">
                      <p><%= clip.createdAtLabel %></p>
                      <p class="timeline-row__meta">by <%= clip.requestedBy %></p>
                    </div>
                    <div class="timeline-row__content">
                      <p class="timeline-row__note"><%= clip.note ?? 'No note provided' %></p>
                      <% if (clip.error && !clip.url) { %>
                        <details class="timeline-row__error">
                          <summary>Error details</summary>
                          <pre><%= clip.error %></pre>
                        </details>
                      <% } %>
                    </div>
                    <div class="timeline-row__actions">
                      <span class="timeline-row__status <%= tone %>"><%= label %></span>
                      <% if (clip.url) { %>
                        <a class="clip-link clip-cta" href="<%= clip.url %>" target="_blank" rel="noreferrer">View clip</a>
                      <% } else if (!clip.error) { %>
                        <p class="muted-copy">Awaiting clip service</p>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              </article>
            <% }) %>
          </div>
        <% } %>
      </section>
    </div>
  </div>
<% } %>
<%- include('layout', { title: `${channel.displayName} clips`, body, sessionActive, showAdminLink: isAdmin }) %>
